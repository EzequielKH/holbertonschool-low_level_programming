more malloc and nested loops

